FROM ubuntu:latest
ENV PATH $PATH:/root/.cargo/bin
# Install all dependencies
RUN apt-get -qq update -y
RUN apt-get install -y -qq curl clang git make cmake golang python

# Cache source
RUN git clone --depth 1 https://github.com/pingcap/tikv /cache

WORKDIR /cache

# Pull in Rust toolchain
RUN curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain `tail -n 1 /cache/RUST_VERSION` -y

# Ensure we have rustfmt
RUN rustup component add rustfmt-preview
RUN rustup component add clippy-preview

# Prebuild artifacts to try to save time
# This should be moved to `./target` in a CI build.

# RocksDB is gigantic, do it individually.
RUN cargo build --package rocksdb -vvv
RUN cargo build --all --benches --tests --examples --bin -vvv

# Wipe everything but the target cache
# In a test run, copy `/cache/target` to the build folder.
RUN find . -maxdepth 1 ! -iname target -exec rm -rf {} \;

