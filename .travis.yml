sudo: required

language: generic

cache:
  directories:
    - /home/travis/docker

services:
  - docker

jobs:
  include:
    - stage: image
      script: |
        # See if this is needed
        git diff-index --name-only "HEAD^" | grep -e docker/ci_dockerfile -e Cargo.lock -e RUST_VERSION || [ ! -f  /home/travis/docker/ci.tar.gz ] || exit 0
        # Do a build
        docker build -t ci --force-rm --no-cache -f docker/ci_dockerfile .
        mkdir -p /home/travis/docker
        docker save ci > /home/travis/docker/ci.tar.gz
    - stage: format
      script: |
        zcat /home/travis/docker/ci.tar.gz | docker load
        docker run -ti --rm -v `pwd`:/build ci bash -c <<-EOF
          cd /build &&
          ln /cache/target target &&
          (make format &&
            git diff-index --quiet HEAD -- ||
            (git diff; echo please make format and run tests before creating a PR!; exit 1)
          )
        EOF
    - stage: test
      script: |
        docker run -ti --rm ci bash -c <<-EOF
          cd /build &&
          ln /cache/target target &&
          make trace_test
        EOF
